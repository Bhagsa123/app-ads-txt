<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>DocScanner — Analytics Dashboard</title>

  <!-- Materialize CSS (Material style quick start) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    body{padding:12px;background:#f5f7fb}
    .card-stats{display:flex;justify-content:space-between;align-items:center}
    .stat-value{font-size:1.6rem;font-weight:700}
    .small-muted{font-size:0.85rem;color:rgba(0,0,0,0.6)}
    @media (max-width:600px){.card-stats{flex-direction:column;align-items:flex-start}}
  </style>
</head>
<body>
  <div class="container">
    <h5>DocScanner — Analytics</h5>
    <p class="small-muted">Mobile-responsive admin dashboard (Material style). Replace <code>YOUR_FIREBASE_CONFIG</code> with your Firebase project config. Create an admin user (see instructions below).</p>

    <!-- Login area -->
    <div id="loginCard" class="card">
      <div class="card-content">
        <span class="card-title">Admin login</span>
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="email" type="text" value="admin@yourdomain.com">
            <label for="email">Admin email</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="password" type="password" value="Bhagsa123">
            <label for="password">Password</label>
          </div>
        </div>
        <a id="btnLogin" class="btn">Login</a>
        <a id="btnLogout" class="btn red lighten-1" style="display:none;">Logout</a>
      </div>
    </div>

    <!-- Controls -->
    <div id="controls" style="display:none">
      <div class="row">
        <div class="col s12 m4">
          <label>Time range</label>
          <select id="timeRange">
            <option value="today" selected>Today</option>
            <option value="week">This Week</option>
            <option value="month">This Month</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div class="col s12 m4">
          <label>Feature filter</label>
          <select id="featureFilter">
            <option value="all" selected>All features</option>
            <!-- feature options are populated dynamically -->
          </select>
        </div>
        <div class="col s12 m4" style="padding-top:18px">
          <a id="btnRefresh" class="btn">Refresh</a>
        </div>
      </div>

      <!-- Cards -->
      <div id="statsRow" class="row"></div>

      <!-- Top features list -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">Top features (by usage)</span>
          <ul id="topFeatures" class="collection"></ul>
        </div>
      </div>

      <!-- Raw events table (last 50) -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">Recent events</span>
          <table class="highlight responsive-table">
            <thead><tr><th>Time</th><th>Event</th><th>User</th><th>Meta</th></tr></thead>
            <tbody id="eventsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Footer / instructions -->
    <div class="card-panel grey lighten-4">
      <strong>Setup steps (quick):</strong>
      <ol>
        <li>Create a Firebase project at console.firebase.google.com</li>
        <li>Enable Authentication &amp; create an admin user (email: <code>admin@yourdomain.com</code>, password: <code>Bhagsa123</code>) or use your preferred email.</li>
        <li>Enable Cloud Firestore and create a collection named <code>analytics</code>.</li>
        <li>Replace the <code>firebaseConfig</code> below with your project's config and publish to Firebase Hosting (or any static host).</li>
        <li>Add the Kotlin snippet (below) to your Android app to send events to Firestore.</li>
      </ol>
      <p class="small-muted">Important: Storing passwords in client-side code is insecure. Use this only for quick testing. For production use: secure admin area + server-side auth or Firebase Custom Claims.</p>
    </div>

    <!-- Hidden area: Firebase config and code (for copying) -->
    <pre id="firebaseNotice" style="display:none">// Replace with your firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBcD2O4GLzQOQEcrRpWTVxTgxuG73y3xJs",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "proscanner-66902",
  storageBucket: "proscanner-66902.firebasestorage.app",
  messagingSenderId: "917717270059",
  appId: "1:917717270059:android:1c35f84b3fc12aea5df46e"
};</pre>

  </div>

  <!-- Firebase (compat SDK for simple example) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // ---- Replace this config with your Firebase project's config ----
    const firebaseConfig = {
     apiKey: "AIzaSyBcD2O4GLzQOQEcrRpWTVxTgxuG73y3xJs",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "proscanner-66902",
  storageBucket: "proscanner-66902.firebasestorage.app",
  messagingSenderId: "917717270059",
  appId: "1:917717270059:android:1c35f84b3fc12aea5df46e"
    };
    // ----------------------------------------------------------------

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', function() {
      var selects = document.querySelectorAll('select');
      M.FormSelect.init(selects);
    });

    // UI elements
    const loginCard = document.getElementById('loginCard');
    const controls = document.getElementById('controls');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const btnRefresh = document.getElementById('btnRefresh');
    const timeRange = document.getElementById('timeRange');
    const featureFilter = document.getElementById('featureFilter');
    const statsRow = document.getElementById('statsRow');
    const topFeatures = document.getElementById('topFeatures');
    const eventsTable = document.getElementById('eventsTable');

    // Login handlers
    btnLogin.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (e) {
        M.toast({html: 'Login failed: '+e.message});
      }
    });
    btnLogout.addEventListener('click', async () => { await auth.signOut(); });

    auth.onAuthStateChanged(async user => {
      if (user) {
        loginCard.style.display = 'none';
        controls.style.display = '';
        btnLogout.style.display = '';
        loadFeatureOptions();
        fetchAll();
      } else {
        loginCard.style.display = '';
        controls.style.display = 'none';
        btnLogout.style.display = 'none';
      }
    });

    btnRefresh.addEventListener('click', fetchAll);
    timeRange.addEventListener('change', fetchAll);
    featureFilter.addEventListener('change', fetchAll);

    // Utility: compute start timestamp for ranges
    function rangeStart(range) {
      const now = new Date();
      if (range === 'today') {
        return new Date(now.getFullYear(), now.getMonth(), now.getDate());
      }
      if (range === 'week') {
        const day = now.getDay(); // 0 (Sun) - 6
        const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
        return new Date(now.getFullYear(), now.getMonth(), diff);
      }
      if (range === 'month') {
        return new Date(now.getFullYear(), now.getMonth(), 1);
      }
      return new Date(0); // all
    }

    // Load unique features from analytics collection (to populate filter)
    async function loadFeatureOptions(){
      featureFilter.innerHTML = '<option value="all" selected>All features</option>';
      // get distinct eventType values (simple approach: query last 1000 docs)
      const snap = await db.collection('analytics').orderBy('timestamp','desc').limit(1000).get();
      const set = new Set();
      snap.forEach(d => { set.add(d.data().eventType || 'unknown'); });
      Array.from(set).sort().forEach(f => {
        const opt = document.createElement('option');
        opt.value = f; opt.text = f; featureFilter.appendChild(opt);
      });
      M.FormSelect.init(document.querySelectorAll('select'));
    }

    // Fetch counts and lists
    async function fetchAll(){
      statsRow.innerHTML = '';
      topFeatures.innerHTML = '';
      eventsTable.innerHTML = '';

      const range = timeRange.value;
      const feature = featureFilter.value;
      const start = rangeStart(range);

      // Query for counts per eventType (aggregate in client)
      const q = db.collection('analytics').where('timestamp','>=', firebase.firestore.Timestamp.fromDate(start)).orderBy('timestamp','desc').limit(5000);
      const snap = await q.get();

      const counts = {};
      const recent = [];
      snap.forEach(doc => {
        const data = doc.data();
        const ev = data.eventType || 'unknown';
        counts[ev] = (counts[ev]||0) + 1;
        recent.push({t: data.timestamp ? data.timestamp.toDate() : new Date(), e: ev, u: data.uid||'-', m: JSON.stringify(data.meta||{})});
      });

      // Show key cards: total scans, today's scans, app opens, pdf shares
      const keys = ['scan','app_open','pdf_share','export_pdf','ocr','crop','rotate','share','delete','rename','favorite'];
      keys.forEach(k=>{
        if (feature !== 'all' && feature !== k) return;
        const val = counts[k] || 0;
        const col = document.createElement('div'); col.className = 'col s12 m4';
        col.innerHTML = `
          <div class="card">
            <div class="card-content">
              <div class="card-stats">
                <div>
                  <div class="stat-value">${val}</div>
                  <div class="small-muted">${k.replace('_',' ')} (${range})</div>
                </div>
                <i class="material-icons large">insert_chart</i>
              </div>
            </div>
          </div>`;
        statsRow.appendChild(col);
      });

      // Top features by count
      const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      entries.slice(0,20).forEach(([k,v])=>{
        const li = document.createElement('li'); li.className='collection-item';
        li.innerHTML = `<div>${k} <span class="secondary-content">${v}</span></div>`;
        topFeatures.appendChild(li);
      });

      // Recent events table (first 50)
      recent.slice(0,50).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.t.toLocaleString()}</td><td>${r.e}</td><td>${r.u}</td><td>${r.m}</td>`;
        eventsTable.appendChild(tr);
      });
    }

    // OPTIONAL: auto refresh every 60s (commented out)
    // setInterval(()=>{ if (auth.currentUser) fetchAll(); }, 60000);

  </script>

  <!-- Kotlin snippet (for copy/paste) -->
  <details>
    <summary style="cursor:pointer;padding:8px">Android Kotlin code — copy to your app (click to expand)</summary>
    <pre style="white-space:pre-wrap">
// build.gradle (app) dependencies:
// implementation 'com.google.firebase:firebase-firestore-ktx:24.7.1'
// implementation 'com.google.firebase:firebase-auth-ktx:22.1.0'

// Initialize Firebase in Application class or MainActivity
// FirebaseApp.initializeApp(this)

// Simple logger to add analytics event to Firestore
fun logAnalyticsEvent(eventType: String, uid: String?, meta: Map<String, Any>? = null) {
    val db = com.google.firebase.firestore.FirebaseFirestore.getInstance()
    val data = HashMap<String, Any>()
    data["eventType"] = eventType
    data["timestamp"] = com.google.firebase.Timestamp.now()
    if (uid != null) data["uid"] = uid
    if (meta != null) data["meta"] = meta

    // Add event document
    db.collection("analytics")
      .add(data)
      .addOnSuccessListener { doc ->
          // Optionally update an aggregate counter using transaction
          val aggRef = db.collection("aggregates").document(eventType)
          db.runTransaction { transaction ->
              val snap = try { transaction.get(aggRef) } catch (e: Exception) { null }
              val old = snap?.getLong("count") ?: 0L
              transaction.set(aggRef, mapOf("count" to old + 1), com.google.firebase.firestore.SetOptions.merge())
          }
      }
      .addOnFailureListener { e ->
          // handle error
      }
}

// Usage examples in your app code:
// logAnalyticsEvent("scan", FirebaseAuth.getInstance().currentUser?.uid)
// logAnalyticsEvent("pdf_share", FirebaseAuth.getInstance().currentUser?.uid, mapOf("method" to "whatsapp"))
    </pre>
  </details>

  <!-- Firestore Security Rules example (use in Firebase Console -> Rules) -->
  <details>
    <summary style="cursor:pointer;padding:8px">Firestore rules (example)</summary>
    <pre>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // analytics collection: allow authenticated clients to write (log events)
    match /analytics/{doc} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.token.email == 'admin@yourdomain.com';
    }
    // aggregates: allow read to admin, deny public write
    match /aggregates/{doc} {
      allow read: if request.auth != null && request.auth.token.email == 'admin@yourdomain.com';
      allow write: if false; // only update via server or Cloud Functions
    }
  }
}
    </pre>
  </details>

</body>
</html>
